name: CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

# Cancel in-progress runs for PRs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

env:
  CACHE_VERSION: 1
  MIX_ENV: test

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: git config --global init.defaultBranch main

      - name: Determine Elixir version
        id: elixir_version
        run: |
          if [ -f .tool-versions ]; then
            echo "version=$(grep -h elixir .tool-versions | awk '{ print $2 }' | awk -F - '{print $1}')" >> $GITHUB_OUTPUT
          else
            echo "version=1.19.4" >> $GITHUB_OUTPUT
          fi

      - name: Determine OTP version
        id: otp_version
        run: |
          if [ -f .tool-versions ]; then
            echo "version=$(grep -h erlang .tool-versions | awk '{ print $2 }')" >> $GITHUB_OUTPUT
          else
            echo "version=28.0" >> $GITHUB_OUTPUT
          fi

      - name: Setup Beam
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ steps.otp_version.outputs.version }}
          elixir-version: ${{ steps.elixir_version.outputs.version }}

      - name: Restore deps cache
        uses: actions/cache@v4
        id: deps-cache
        with:
          path: deps
          key: ${{ runner.os }}-${{ steps.elixir_version.outputs.version }}-${{ steps.otp_version.outputs.version }}-deps-v${{ env.CACHE_VERSION }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ steps.elixir_version.outputs.version }}-${{ steps.otp_version.outputs.version }}-deps-v${{ env.CACHE_VERSION }}-

      - name: Restore _build cache
        uses: actions/cache@v4
        id: build-cache
        with:
          path: _build
          key: ${{ runner.os }}-${{ steps.elixir_version.outputs.version }}-${{ steps.otp_version.outputs.version }}-build-v${{ env.CACHE_VERSION }}-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ steps.elixir_version.outputs.version }}-${{ steps.otp_version.outputs.version }}-build-v${{ env.CACHE_VERSION }}-

      - name: Install hex and rebar
        run: |
          mix local.hex --force
          mix local.rebar --force

      - name: Install dependencies
        run: mix deps.get

      - name: Compile dependencies
        run: mix deps.compile

      - name: Compile application
        run: mix compile --warnings-as-errors --force

      - name: Check code formatting
        run: mix format --check-formatted

      - name: Run tests
        run: mix test
